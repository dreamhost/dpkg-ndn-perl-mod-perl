#!/usr/bin/make -f

DH_VERBOSE=1
TMP  := $(CURDIR)/debian/tmp
BUILDHOME := $(CURDIR)/debian/build

# Allow disabling build optimation by setting noopt in
# $DEB_BUILD_OPTIONS
CFLAGS = -Wall -g
ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
        CFLAGS += -O0
else
        CFLAGS += -O2
endif

# If set to a true value then MakeMaker's prompt function will
# always return the default without waiting for user input.
export PERL_MM_USE_DEFAULT=1

ifndef PERL
PERL = /usr/bin/perl
endif

ifndef MAKE
MAKE = /usr/bin/make
endif

%:
	dh $@

override_dh_auto_configure:
	echo "USER: ${USER}"
	dh_auto_configure -- \
	APACHE_TEST_HTTPD=/usr/sbin/apache2 \
		APACHE_TEST_APXS=/usr/bin/apxs2 \
	APACHE_TEST_USER=www-data \
		APACHE_TEST_GROUP=www-data \
		INSTALLDIRS=vendor \
		MP_USE_GTOP=1 \
		MP_TRACE=0 \
		MP_USE_DSO=1 \
		MP_USE_STATIC=0 \
		MP_CCOPTS="-g -Wall" \
		MP_INCLUDE_DIR=/usr/include/apache2 \
		MP_APXS=/usr/bin/apxs2 \
		MP_INCLUDE_DIR=/usr/include/apr-1.0 
#	$(MAKE) OPTIMIZE="$(CFLAGS)" LD_RUN_PATH=""



override_dh_auto_test:
	APACHE_TEST_HTTPD=/usr/sbin/apache2 \
		APACHE_TEST_APXS=/usr/bin/apxs2 \
		MP_USE_GTOP=1 \
		MP_TRACE=0 \
		MP_USE_DSO=1 \
		MP_USE_STATIC=0 \
		MP_CCOPTS="-g -Wall" \
		MP_INCLUDE_DIR=/usr/include/apache2 \
		MP_APXS=/usr/bin/apxs2 \
		MP_INCLUDE_DIR=/usr/include/apr-1.0 \
	APACHE_TEST_EXTRA_ARGS="-httpd_conf /etc/apache2/apache2.conf" LANG=C APACHE_TEST_USER=www-data APACHE_TEST_GROUP=www-data dh_auto_test 

override_dh_clean:
	dh_clean
	rm -rf t/htdocs/hooks lib/Apache WrapXS

override_dh_install:
	dh_install
	mv $(TMP)/usr/bin/mp2bug $(TMP)/usr/share/libapache2-mod-perl2/
	rm -rf $(TMP)/usr/bin/
	install -m755 debian/libapache2-mod-perl2.bug $(TMP)/usr/share/bug/libapache2-mod-perl2

