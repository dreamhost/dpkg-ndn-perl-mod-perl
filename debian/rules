#!/usr/bin/make -f

TMP  := $(CURDIR)/debian/libapache2-mod-perl2

# Allow disabling build optimation by setting noopt in
# $DEB_BUILD_OPTIONS
CFLAGS = -Wall -g
ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
        CFLAGS += -O0
else
        CFLAGS += -O2
endif

%:
	dh $@

override_dh_auto_configure:
	dh_auto_configure -- \
		INSTALLDIRS=vendor \
		MP_USE_GTOP=1 \
		MP_TRACE=0 \
		MP_USE_DSO=1 \
		MP_USE_STATIC=0 \
		MP_CCOPTS="-g -Wall" \
		MP_INCLUDE_DIR=/usr/include/apache2 \
		MP_APXS=/usr/bin/apxs2 \
		MP_INCLUDE_DIR=/usr/include/apr-1.0 

#	APACHE_TEST_HTTPD=/usr/sbin/apache2 \
#		APACHE_TEST_APXS=/usr/bin/apxs2 \
# APACHE_TEST_USER=www-data APACHE_TEST_GROUP=www-data dh_auto_test

override_dh_auto_test:
		MP_USE_GTOP=1 \
		MP_TRACE=0 \
		MP_USE_DSO=1 \
		MP_USE_STATIC=0 \
		MP_CCOPTS="-g -Wall" \
		MP_INCLUDE_DIR=/usr/include/apache2 \
		MP_APXS=/usr/bin/apxs2 \
		MP_INCLUDE_DIR=/usr/include/apr-1.0 \
	APACHE_TEST_EXTRA_ARGS="-httpd_conf /etc/apache2/apache2.conf" LANG=C

override_dh_clean:
	dh_clean
	rm -rf t/htdocs/hooks lib/Apache WrapXS

override_dh_install:
	dh_install
	mv $(TMP)/usr/bin/mp2bug $(TMP)/usr/share/libapache2-mod-perl2/
	rm -rf $(TMP)/usr/bin/
	install -m755 debian/libapache2-mod-perl2.bug $(TMP)/usr/share/bug/libapache2-mod-perl2

# These rules are needed because otherwise the build process
# gets messed up and the tests fail.
# Thanks to Damyan Ivanov for figuring this out.
.PHONY: build

build:
	dh build

