#!/usr/bin/make -f

TMP  := $(CURDIR)/debian/libapache2-mod-perl2

%:
	dh $@

override_dh_auto_configure:
	dh_auto_configure -- \
		INSTALLDIRS=vendor \
		MP_USE_GTOP=1 \
		MP_TRACE=0 \
		MP_USE_DSO=1 \
		MP_USE_STATIC=0 \
		MP_CCOPTS="-g -Wall" \
		MP_INCLUDE_DIR=/usr/include/apache2 \
		MP_APXS=/usr/bin/apxs2 \
		MP_INCLUDE_DIR=/usr/include/apr-1.0 

override_dh_auto_test:
	APACHE_TEST_EXTRA_ARGS="-httpd_conf /etc/apache2/apache2.conf"
		LANG=C \
		dh_auto_test 

override_dh_clean:
	dh_clean
	rm -rf t/htdocs/hooks lib/Apache WrapXS debian/docs
	find . -name 'pod2htmd.tmp' -exec rm '{}' \;
	find . -name 'pod2htmi.tmp' -exec rm '{}' \;

override_dh_install:
	mkdir -p $(CURDIR)/debian/docs
	perl debian/transform_pod2html.pl $(CURDIR) docs debian/docs
	dh_install
	mv $(TMP)/usr/bin/mp2bug $(TMP)/usr/share/libapache2-mod-perl2/
	rm -rf $(TMP)/usr/bin/
	install -m755 debian/libapache2-mod-perl2.bug $(TMP)/usr/share/bug/libapache2-mod-perl2

# These rules are needed because otherwise the build process
# gets messed up and the tests fail.
# Thanks to Damyan Ivanov for figuring this out.
.PHONY: build

build:
	dh build

